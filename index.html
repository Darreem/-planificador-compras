<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Compras Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-btn { transition: all 0.3s ease; }
        .tab-btn.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .table-input { background-color: transparent; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; }
        .table-input:focus { outline: 2px solid #4f46e5; border-color: transparent; }
        .priority-ya { background-color: #fee2e2; color: #b91c1c; }
        .priority-pronto { background-color: #fef3c7; color: #a16207; }
        .priority-ok { background-color: #dcfce7; color: #15803d; }
        .backup-indicator { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 8px 16px; border-radius: 8px; font-size: 12px; opacity: 0; transition: opacity 0.3s; }
        .backup-indicator.show { opacity: 1; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- Indicador de guardado -->
    <div id="backup-indicator" class="backup-indicator">‚úì Datos guardados</div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Planificador de Compras Inteligente</h1>
            <p class="text-lg text-gray-600 mt-2">Optimiza tu presupuesto de frutas y verduras y reduce el desperdicio.</p>
            
            <!-- Controles de datos -->
            <div class="mt-4 space-x-4">
                <button id="export-data" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">üì• Exportar Datos</button>
                <button id="import-data" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">üì§ Importar Datos</button>
                <input type="file" id="import-file" accept=".json" style="display: none;">
                <button id="clear-data" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">üóëÔ∏è Limpiar Todo</button>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px" id="tabs">
                <button class="tab-btn active text-lg font-semibold py-4 px-6 border-b-2 border-transparent hover:border-gray-300 focus:outline-none" data-tab="dashboard">üìä Dashboard</button>
                <button class="tab-btn text-lg font-semibold py-4 px-6 border-b-2 border-transparent hover:border-gray-300 focus:outline-none" data-tab="lista_compras">üõí Lista de Compras</button>
                <button class="tab-btn text-lg font-semibold py-4 px-6 border-b-2 border-transparent hover:border-gray-300 focus:outline-none" data-tab="precios">üí∏ Precios</button>
                <button class="tab-btn text-lg font-semibold py-4 px-6 border-b-2 border-transparent hover:border-gray-300 focus:outline-none" data-tab="inventario">üè† Inventario</button>
                <button class="tab-btn text-lg font-semibold py-4 px-6 border-b-2 border-transparent hover:border-gray-300 focus:outline-none" data-tab="plan_semanal">üóìÔ∏è Plan Semanal</button>
                <button class="tab-btn text-lg font-semibold py-4 px-6 border-b-2 border-transparent hover:border-gray-300 focus:outline-none" data-tab="guia">üí° Gu√≠a y Consejos</button>
            </nav>
        </div>

        <!-- Tabs Content -->
        <div id="tab-content">
            <!-- Dashboard -->
            <div id="dashboard" class="tab-pane active space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-500">Presupuesto Semanal (S/)</h3>
                        <input type="number" id="presupuesto-semanal" class="text-4xl font-bold text-indigo-600 w-full mt-2 bg-gray-100 p-2 rounded-lg" value="150">
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-500">Total Estimado Compra</h3>
                        <p id="total-estimado" class="text-4xl font-bold text-green-600 mt-2">S/ 0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-500">Gasto Real (√öltimos 7 d√≠as)</h3>
                        <p id="gasto-real" class="text-4xl font-bold text-orange-600 mt-2">S/ 0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-500">Ahorro Estimado</h3>
                        <p id="ahorro-estimado" class="text-4xl font-bold text-blue-600 mt-2">S/ 0.00</p>
                    </div>
                </div>
            </div>

            <!-- Lista de Compras -->
            <div id="lista_compras" class="tab-pane hidden">
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Lista de Compras de la Semana</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-100 text-gray-600">
                                <tr>
                                    <th class="p-3">Producto</th>
                                    <th class="p-3">Cantidad</th>
                                    <th class="p-3">Tienda Sugerida</th>
                                    <th class="p-3 text-right">Precio M√≠nimo Unitario</th>
                                    <th class="p-3 text-right">Subtotal Estimado</th>
                                    <th class="p-3 text-center">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="lista-compras-body"></tbody>
                        </table>
                    </div>
                    <button id="add-lista-item-btn" class="mt-4 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">A√±adir Producto</button>
                </div>
            </div>

            <!-- Precios -->
            <div id="precios" class="tab-pane hidden">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Registro de Precios</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-100 text-gray-600">
                                <tr>
                                    <th class="p-3">Fecha</th>
                                    <th class="p-3">Tienda</th>
                                    <th class="p-3">Producto</th>
                                    <th class="p-3">Unidad (kg, atado)</th>
                                    <th class="p-3 text-right">Cantidad</th>
                                    <th class="p-3 text-right">Precio Total (S/)</th>
                                    <th class="p-3 text-right font-bold">Precio Unitario (S/)</th>
                                    <th class="p-3 text-center">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="precios-body"></tbody>
                        </table>
                    </div>
                    <button id="add-precio-item-btn" class="mt-4 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">A√±adir Compra</button>
                </div>
            </div>

            <!-- Inventario -->
            <div id="inventario" class="tab-pane hidden">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Inventario de Casa</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-100 text-gray-600">
                                <tr>
                                    <th class="p-3">Producto</th>
                                    <th class="p-3">Fecha Compra</th>
                                    <th class="p-3">Fecha Consumo/Venc.</th>
                                    <th class="p-3">D√≠as Restantes</th>
                                    <th class="p-3 text-center font-bold">Prioridad</th>
                                    <th class="p-3 text-center">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="inventario-body"></tbody>
                        </table>
                    </div>
                    <button id="add-inventario-item-btn" class="mt-4 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">A√±adir Producto</button>
                </div>
            </div>
            
            <!-- Plan Semanal -->
            <div id="plan_semanal" class="tab-pane hidden">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Plan Semanal de Frutas y Verduras</h2>
                    <div class="overflow-x-auto">
                         <table class="w-full border-collapse border border-gray-300">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-200 p-3">D√≠a</th>
                                    <th class="border border-gray-200 p-3">Desayuno</th>
                                    <th class="border border-gray-200 p-3">Postre / Almuerzo</th>
                                    <th class="border border-gray-200 p-3">Snacks</th>
                                </tr>
                            </thead>
                            <tbody id="plan-semanal-body">
                                <!-- Filas generadas por JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Gu√≠a y Consejos -->
            <div id="guia" class="tab-pane hidden space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">C√≥mo Usarlo (5 pasos)</h2>
                    <ol class="list-decimal list-inside space-y-2 text-gray-700">
                        <li><b>Plan semanal (r√°pido):</b> En "Plan_Semanal" anoten qu√© frutas/verduras comer√°n cada d√≠a.</li>
                        <li><b>Revisen la casa:</b> En "Inventario" escriban lo que ya tienen, con fecha de compra y fecha de consumo/vencimiento.</li>
                        <li><b>Anoten precios reales:</b> Cada vez que compren, registren en "Precios". Se calcula el precio unitario autom√°ticamente.</li>
                        <li><b>Armen la compra de la semana:</b> En "Lista_de_Compras" pongan lo que necesitan. La app busca el precio m√≠nimo y sugiere la tienda m√°s barata.</li>
                        <li><b>Controlen el presupuesto:</b> En "Dashboard" fijen su Presupuesto y vean el Total estimado, Gasto real y Ahorro.</li>
                    </ol>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Trucos para que rinda toda la semana</h2>
                    <ul class="list-disc list-inside space-y-2 text-gray-700">
                        <li><b>Compra escalonada:</b> 2 tandas/semana (p. ej., s√°b + mi√©).</li>
                        <li><b>Maduraci√≥n por lotes:</b> Lleven pl√°tanos de distintas madureces; manzanas/pera duran m√°s.</li>
                        <li><b>Unidad comparada (S/ por kg o por unidad):</b> Siempre comparen por precio unitario (la app lo calcula).</li>
                        <li><b>Almacenamiento b√°sico:</b> Hierbas en taper con papel toalla; berries sin lavar hasta consumir; tomate fuera de refri si est√° duro.</li>
                        <li><b>"Primero lo que vence":</b> Usen la columna de Prioridad del inventario para decidir el men√∫.</li>
                    </ul>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Mini gu√≠a de cantidades orientativas (2 personas)</h2>
                     <p class="text-gray-700"><b>Desayunos/snacks:</b> ~2‚Äì3 porciones de fruta/d√≠a ‚Üí 14‚Äì21 porciones/semana.</p>
                     <p class="mt-2 text-gray-700"><b>Compra inicial sugerida:</b></p>
                    <ul class="list-disc list-inside space-y-1 text-gray-700 mt-1">
                        <li>Pl√°tano 2‚Äì3 kg</li>
                        <li>Manzana/Pera 1‚Äì2 kg</li>
                        <li>Papaya/Sand√≠a 1 unidad</li>
                        <li>C√≠tricos 1‚Äì2 kg</li>
                        <li>Tomate 1 kg</li>
                        <li>Zanahoria 1 kg</li>
                        <li>Hojas verdes 2‚Äì3 atados</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // STATE MANAGEMENT CON MEJOR PERSISTENCIA
    let state = {
        presupuesto: 150,
        precios: [
            { id: 1, fecha: '2025-08-25', tienda: 'Mercado Local', producto: 'Pl√°tano', unidad: 'kg', cantidad: 2.5, precioTotal: 7.50 },
            { id: 2, fecha: '2025-08-25', tienda: 'Supermercado', producto: 'Manzana', unidad: 'kg', cantidad: 1.5, precioTotal: 9.00 },
            { id: 3, fecha: '2025-08-28', tienda: 'Supermercado', producto: 'Pl√°tano', unidad: 'kg', cantidad: 2, precioTotal: 6.80 },
        ],
        inventario: [
             { id: 1, producto: 'Tomate', fechaCompra: '2025-08-28', fechaVenc: '2025-09-05' },
             { id: 2, producto: 'Lechuga', fechaCompra: '2025-08-28', fechaVenc: '2025-09-02' },
        ],
        listaCompras: [
            { id: 1, producto: 'Pl√°tano', cantidad: 3 },
            { id: 2, producto: 'Manzana', cantidad: 2 },
            { id: 3, producto: 'Zanahoria', cantidad: 1 },
        ],
        planSemanal: {
            'Lunes': { desayuno: 'Papaya', almuerzo: 'Ensalada', snacks: 'Manzana' },
            'Martes': { desayuno: 'Pl√°tano', almuerzo: 'Sopa de verduras', snacks: 'Naranja' },
            'Mi√©rcoles': { desayuno: 'Jugo de fresa', almuerzo: 'Tomates rellenos', snacks: 'Pera' },
            'Jueves': { desayuno: 'Avena con ar√°ndanos', almuerzo: 'Ensalada', snacks: 'Pl√°tano' },
            'Viernes': { desayuno: 'Sand√≠a', almuerzo: 'Verduras salteadas', snacks: 'Manzana' },
            'S√°bado': { desayuno: 'Pl√°tano', almuerzo: 'Ensalada de frutas', snacks: 'Mandarina' },
            'Domingo': { desayuno: 'Mel√≥n', almuerzo: 'Pimientos al horno', snacks: 'Uvas' },
        },
        lastBackup: null,
        version: '1.0'
    };

    // FUNCIONES DE PERSISTENCIA MEJORADAS
    const STORAGE_KEY = 'shoppingPlannerState_v1';
    const BACKUP_KEY = 'shoppingPlannerBackup_v1';

    const loadState = () => {
        try {
            const savedState = localStorage.getItem(STORAGE_KEY);
            if (savedState) {
                const parsed = JSON.parse(savedState);
                // Validar estructura b√°sica
                if (parsed.version && parsed.precios && parsed.inventario) {
                    state = { ...state, ...parsed };
                    console.log('‚úÖ Datos cargados correctamente');
                }
            }
        } catch (error) {
            console.error('‚ùå Error cargando datos:', error);
            // Intentar cargar backup
            loadBackup();
        }
    };

    const saveState = () => {
        try {
            state.lastBackup = new Date().toISOString();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            // Crear backup cada 10 cambios
            if (!state.backupCount) state.backupCount = 0;
            state.backupCount++;
            if (state.backupCount % 10 === 0) {
                localStorage.setItem(BACKUP_KEY, JSON.stringify(state));
            }
            showBackupIndicator();
            renderAll();
        } catch (error) {
            console.error('‚ùå Error guardando datos:', error);
            alert('Error guardando datos. Verifica el espacio disponible.');
        }
    };

    const loadBackup = () => {
        try {
            const backup = localStorage.getItem(BACKUP_KEY);
            if (backup) {
                state = { ...state, ...JSON.parse(backup) };
                console.log('üîÑ Backup cargado');
            }
        } catch (error) {
            console.error('‚ùå Error cargando backup:', error);
        }
    };

    const showBackupIndicator = () => {
        const indicator = document.getElementById('backup-indicator');
        indicator.classList.add('show');
        setTimeout(() => indicator.classList.remove('show'), 2000);
    };

    // FUNCIONES DE EXPORTAR/IMPORTAR
    const exportData = () => {
        try {
            const dataStr = JSON.stringify(state, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `planificador-compras-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        } catch (error) {
            console.error('‚ùå Error exportando:', error);
            alert('Error al exportar datos');
        }
    };

    const importData = (file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedState = JSON.parse(e.target.result);
                if (importedState.version && importedState.precios) {
                    if (confirm('¬øReemplazar todos los datos actuales?')) {
                        state = importedState;
                        saveState();
                        alert('‚úÖ Datos importados correctamente');
                    }
                } else {
                    alert('‚ùå Archivo no v√°lido');
                }
            } catch (error) {
                console.error('‚ùå Error importando:', error);
                alert('‚ùå Error al leer el archivo');
            }
        };
        reader.readAsText(file);
    };

    const clearAllData = () => {
        if (confirm('‚ö†Ô∏è ¬øEst√°s seguro? Se borrar√°n TODOS los datos.')) {
            if (confirm('üö® √öLTIMA CONFIRMACI√ìN: ¬øBorrar todo?')) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(BACKUP_KEY);
                location.reload();
            }
        }
    };
    
    // UTILS
    const getTodayDate = () => new Date().toISOString().split('T')[0];
    const formatCurrency = (value) => `S/ ${Number(value || 0).toFixed(2)}`;
    const normalizeString = (str) => str.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

    // RENDER FUNCTIONS (igual que antes pero con mejor manejo de errores)
    const renderAll = () => {
        try {
            renderPrecios();
            renderInventario();
            renderListaCompras();
            renderPlanSemanal();
            renderDashboard();
        } catch (error) {
            console.error('‚ùå Error renderizando:', error);
        }
    };

    const renderPrecios = () => {
        const tbody = document.getElementById('precios-body');
        tbody.innerHTML = '';
        state.precios.forEach(item => {
            const precioUnitario = item.cantidad > 0 ? (item.precioTotal / item.cantidad).toFixed(2) : 0;
            const row = document.createElement('tr');
            row.className = 'border-b';
            row.innerHTML = `
                <td class="p-3"><input type="date" class="table-input" value="${item.fecha}" data-id="${item.id}" data-field="fecha"></td>
                <td class="p-3"><input type="text" class="table-input" value="${item.tienda}" data-id="${item.id}" data-field="tienda"></td>
                <td class="p-3"><input type="text" class="table-input" value="${item.producto}" data-id="${item.id}" data-field="producto"></td>
                <td class="p-3"><input type="text" class="table-input" value="${item.unidad}" data-id="${item.id}" data-field="unidad"></td>
                <td class="p-3"><input type="number" class="table-input text-right" value="${item.cantidad}" data-id="${item.id}" data-field="cantidad"></td>
                <td class="p-3"><input type="number" class="table-input text-right" value="${item.precioTotal.toFixed(2)}" data-id="${item.id}" data-field="precioTotal"></td>
                <td class="p-3 text-right font-bold text-indigo-600">${formatCurrency(precioUnitario)}</td>
                <td class="p-3 text-center"><button class="text-red-500 hover:text-red-700 font-bold" data-id="${item.id}" data-action="delete-precio">X</button></td>
            `;
            tbody.appendChild(row);
        });
    };

    const renderInventario = () => {
        const tbody = document.getElementById('inventario-body');
        tbody.innerHTML = '';
        const today = new Date(getTodayDate());
        state.inventario.forEach(item => {
            const vencDate = new Date(item.fechaVenc);
            const diffTime = vencDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let prioridadClass = 'priority-ok';
            let prioridadText = 'OK';
            if (diffDays <= 2) {
                prioridadClass = 'priority-ya';
                prioridadText = 'Usar YA';
            } else if (diffDays <= 7) {
                prioridadClass = 'priority-pronto';
                prioridadText = 'Usar Pronto';
            }

            const row = document.createElement('tr');
            row.className = 'border-b';
            row.innerHTML = `
                <td class="p-3"><input type="text" class="table-input" value="${item.producto}" data-id="${item.id}" data-field="producto"></td>
                <td class="p-3"><input type="date" class="table-input" value="${item.fechaCompra}" data-id="${item.id}" data-field="fechaCompra"></td>
                <td class="p-3"><input type="date" class="table-input" value="${item.fechaVenc}" data-id="${item.id}" data-field="fechaVenc"></td>
                <td class="p-3">${diffDays >= 0 ? `${diffDays} d√≠as` : 'Vencido'}</td>
                <td class="p-3 text-center"><span class="px-3 py-1 rounded-full font-semibold text-sm ${prioridadClass}">${prioridadText}</span></td>
                <td class="p-3 text-center"><button class="text-red-500 hover:text-red-700 font-bold" data-id="${item.id}" data-action="delete-inventario">X</button></td>
            `;
            tbody.appendChild(row);
        });
    };
    
    const renderListaCompras = () => {
        const tbody = document.getElementById('lista-compras-body');
        tbody.innerHTML = '';
        let totalEstimado = 0;
        state.listaCompras.forEach(item => {
            const { tienda, precioUnitario } = findBestPrice(item.producto);
            const subtotal = item.cantidad * (precioUnitario || 0);
            totalEstimado += subtotal;

            const row = document.createElement('tr');
            row.className = 'border-b';
            row.innerHTML = `
                <td class="p-3"><input type="text" class="table-input" value="${item.producto}" data-id="${item.id}" data-field="producto"></td>
                <td class="p-3"><input type="number" class="table-input" value="${item.cantidad}" data-id="${item.id}" data-field="cantidad"></td>
                <td class="p-3">${tienda || 'N/A'}</td>
                <td class="p-3 text-right">${precioUnitario ? formatCurrency(precioUnitario) : 'N/A'}</td>
                <td class="p-3 text-right font-bold">${formatCurrency(subtotal)}</td>
                <td class="p-3 text-center"><button class="text-red-500 hover:text-red-700 font-bold" data-id="${item.id}" data-action="delete-lista">X</button></td>
            `;
            tbody.appendChild(row);
        });
         document.getElementById('total-estimado').textContent = formatCurrency(totalEstimado);
    };

    const renderPlanSemanal = () => {
        const tbody = document.getElementById('plan-semanal-body');
        tbody.innerHTML = '';
        const dias = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
        dias.forEach(dia => {
            const plan = state.planSemanal[dia] || { desayuno: '', almuerzo: '', snacks: '' };
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="border border-gray-200 p-3 font-semibold bg-gray-50">${dia}</td>
                <td class="border border-gray-200 p-3"><input type="text" class="table-input" value="${plan.desayuno}" data-dia="${dia}" data-field="desayuno"></td>
                <td class="border border-gray-200 p-3"><input type="text" class="table-input" value="${plan.almuerzo}" data-dia="${dia}" data-field="almuerzo"></td>
                <td class="border border-gray-200 p-3"><input type="text" class="table-input" value="${plan.snacks}" data-dia="${dia}" data-field="snacks"></td>
            `;
            tbody.appendChild(row);
        });
    };

    const renderDashboard = () => {
        // Presupuesto
        document.getElementById('presupuesto-semanal').value = state.presupuesto;

        // Gasto Real
        const sevenDaysAgo = new Date(getTodayDate());
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const gastoReal = state.precios
            .filter(p => new Date(p.fecha) >= sevenDaysAgo)
            .reduce((sum, p) => sum + p.precioTotal, 0);
        document.getElementById('gasto-real').textContent = formatCurrency(gastoReal);

        // Ahorro Estimado
        let totalAtAverage = 0;
        let totalAtMin = 0;
        state.listaCompras.forEach(item => {
            const { precioUnitario: minPrice } = findBestPrice(item.producto);
            const avgPrice = findAveragePrice(item.producto);
            totalAtMin += (minPrice || 0) * item.cantidad;
            totalAtAverage += (avgPrice || minPrice || 0) * item.cantidad;
        });
        const ahorro = totalAtAverage - totalAtMin;
        document.getElementById('ahorro-estimado').textContent = formatCurrency(ahorro);
    };

    // BUSINESS LOGIC (igual que antes)
    const findBestPrice = (producto) => {
        const normalizedProd = normalizeString(producto);
        const relevantPrices = state.precios.filter(p => normalizeString(p.producto) === normalizedProd);
        if (relevantPrices.length === 0) return { tienda: null, precioUnitario: null };
        
        const best = relevantPrices.reduce((best, current) => {
            const currentPriceUnit = current.cantidad > 0 ? current.precioTotal / current.cantidad : Infinity;
            const bestPriceUnit = best.cantidad > 0 ? best.precioTotal / best.cantidad : Infinity;
            return currentPriceUnit < bestPriceUnit ? current : best;
        });
        
        return {
            tienda: best.tienda,
            precioUnitario: best.cantidad > 0 ? best.precioTotal / best.cantidad : 0
        };
    };

    const findAveragePrice = (producto) => {
        const normalizedProd = normalizeString(producto);
        const relevantPrices = state.precios.filter(p => normalizeString(p.producto) === normalizedProd);
        if (relevantPrices.length === 0) return null;

        const totalUnitario = relevantPrices.reduce((sum, p) => {
            const unitPrice = p.cantidad > 0 ? p.precioTotal / p.cantidad : 0;
            return sum + unitPrice;
        }, 0);
        return totalUnitario / relevantPrices.length;
    };
    
    // EVENT LISTENERS MEJORADOS
    const setupEventListeners = () => {
        // Tab switching
        const tabs = document.getElementById('tabs');
        tabs.addEventListener('click', (e) => {
            if (e.target.matches('.tab-btn')) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                e.target.classList.add('active');
                document.getElementById(e.target.dataset.tab).classList.remove('hidden');
            }
        });

        // Controles de datos
        document.getElementById('export-data').addEventListener('click', exportData);
        document.getElementById('import-data').addEventListener('click', () => {
            document.getElementById('import-file').click();
        });
        document.getElementById('import-file').addEventListener('change', (e) => {
            if (e.target.files[0]) importData(e.target.files[0]);
        });
        document.getElementById('clear-data').addEventListener('click', clearAllData);

        // Add buttons
        document.getElementById('add-precio-item-btn').addEventListener('click', () => {
            const newId = (state.precios.length > 0 ? Math.max(...state.precios.map(p => p.id)) : 0) + 1;
            state.precios.push({ id: newId, fecha: getTodayDate(), tienda: '', producto: '', unidad: 'kg', cantidad: 1, precioTotal: 0 });
            saveState();
        });
        document.getElementById('add-inventario-item-btn').addEventListener('click', () => {
            const newId = (state.inventario.length > 0 ? Math.max(...state.inventario.map(p => p.id)) : 0) + 1;
            state.inventario.push({ id: newId, producto: '', fechaCompra: getTodayDate(), fechaVenc: getTodayDate() });
            saveState();
        });
        document.getElementById('add-lista-item-btn').addEventListener('click', () => {
             const newId = (state.listaCompras.length > 0 ? Math.max(...state.listaCompras.map(p => p.id)) : 0) + 1;
            state.listaCompras.push({ id: newId, producto: '', cantidad: 1 });
            saveState();
        });
        
        // Data updates and deletions con debounce
        let saveTimeout;
        document.body.addEventListener('change', (e) => {
            if (e.target.matches('.table-input')) {
                const id = parseInt(e.target.dataset.id);
                const field = e.target.dataset.field;
                const value = e.target.type === 'number' ? parseFloat(e.target.value) : e.target.value;
                
                if (e.target.closest('#precios-body')) {
                    const item = state.precios.find(p => p.id === id);
                    if (item) item[field] = value;
                } else if (e.target.closest('#inventario-body')) {
                    const item = state.inventario.find(p => p.id === id);
                    if (item) item[field] = value;
                } else if (e.target.closest('#lista-compras-body')) {
                    const item = state.listaCompras.find(p => p.id === id);
                    if (item) item[field] = value;
                } else if (e.target.closest('#plan-semanal-body')) {
                    const dia = e.target.dataset.dia;
                    if (!state.planSemanal[dia]) state.planSemanal[dia] = {};
                    state.planSemanal[dia][field] = value;
                }
                
                // Debounce para no guardar en cada tecla
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveState, 1000);
            }
        });
        
        document.body.addEventListener('click', (e) => {
            if (e.target.dataset.action) {
                const id = parseInt(e.target.dataset.id);
                switch(e.target.dataset.action) {
                    case 'delete-precio':
                        state.precios = state.precios.filter(p => p.id !== id);
                        break;
                    case 'delete-inventario':
                        state.inventario = state.inventario.filter(p => p.id !== id);
                        break;
                    case 'delete-lista':
                        state.listaCompras = state.listaCompras.filter(p => p.id !== id);
                        break;
                }
                saveState();
            }
        });
        
        document.getElementById('presupuesto-semanal').addEventListener('change', (e) => {
            state.presupuesto = parseFloat(e.target.value);
            saveState();
        });

        // Auto-save cada 5 minutos
        setInterval(() => {
            if (state.lastBackup) {
                const lastSave = new Date(state.lastBackup);
                const now = new Date();
                if (now - lastSave > 300000) { // 5 minutos
                    saveState();
                }
            }
        }, 300000);
    };
    
    // INITIALIZATION
    loadState();
    renderAll();
    setupEventListeners();
    
    // Guardar al cerrar la p√°gina
    window.addEventListener('beforeunload', saveState);
    
    console.log('‚úÖ Planificador de Compras iniciado correctamente');
});
</script>

</body>
</html>